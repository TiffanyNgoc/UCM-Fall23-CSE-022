#include <igloo/igloo.h>
#include <cstdlib>
#include <iostream>
#include <fstream>

using namespace igloo;

std::string exec(std::string command) {
   char buffer[128];
   std::string result = "";

   // Open pipe to file
   FILE* pipe = popen((command + " 2>&1").c_str(), "r");
   if (!pipe) {
      return "popen failed!";
   }

   // read till end of process:
   while (!feof(pipe)) {

      // use buffer to read and add to result
      if (fgets(buffer, 128, pipe) != NULL)
         result += buffer;
   }

   pclose(pipe);
   result.erase(result.find_last_not_of(" \t\n\r\f\v") + 1);
   return result;
}

Context(TextProgram){
    static void SetUpContext(){
        exec("g++ main.cpp -o temp");
    }

    static void TearDownContext() {
        system("rm -rf temp");
    }

    Spec(Cresta){
        std::string result = exec("cat data/cresta.txt | ./temp");
        Assert::That(result, Equals(".---------------------------------------------------------------------------------------------------------------------------------------------------.\n| Cresta Verde Golf Course                                                                                                                          |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Hole             |  1  |  2  |  3  |  4  |  5  |  6  |  7  |  8  |  9  | OUT  | 10  | 11  | 12  | 13  | 14  | 15  | 16  | 17  | 18  |  IN  | TOT  |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Blue             | 518 | 350 | 150 | 236 | 500 | 130 | 374 | 410 | 495 | 3163 | 350 | 320 | 338 | 298 | 151 | 445 | 352 | 200 | 448 | 2902 | 6065 |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| White            | 510 | 340 | 144 | 212 | 470 | 120 | 365 | 390 | 450 | 3001 | 325 | 308 | 330 | 285 | 122 | 435 | 320 | 185 | 430 | 2740 | 5741 |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Red              | 500 | 290 | 110 | 184 | 460 | 92  | 345 | 340 | 425 | 2746 | 315 | 225 | 250 | 280 | 105 | 410 | 310 | 180 | 415 | 2490 | 5236 |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Par              |  5  |  4  |  3  |  3  |  5  |  3  |  4  |  4  |  5  |  36  |  4  |  4  |  4  |  4  |  3  |  5  |  4  |  3  |  5  |  36  |  72  |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Men's Handicap   |  3  | 11  | 15  |  1  | 13  | 17  |  7  |  5  |  9  |      | 12  | 10  | 14  | 18  | 16  |  2  |  6  |  8  |  4  |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Ladies' Handicap |  3  | 13  | 15  |  7  |  1  | 17  |  9  |  5  | 11  |      |  4  | 16  | 14  | 12  | 18  | 10  |  2  |  6  |  8  |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Scorer:                                                                | Attest:                                              | Date:             |\n.---------------------------------------------------------------------------------------------------------------------------------------------------."));
    }

    Spec (Merced) {
        std::string result = exec("cat data/mgcc.txt | ./temp");
        Assert::That(result, Equals(".---------------------------------------------------------------------------------------------------------------------------------------------------.\n| Merced Golf and Country Club                                                                                                                      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Hole             |  1  |  2  |  3  |  4  |  5  |  6  |  7  |  8  |  9  | OUT  | 10  | 11  | 12  | 13  | 14  | 15  | 16  | 17  | 18  |  IN  | TOT  |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Blue             | 323 | 387 | 420 | 181 | 519 | 204 | 559 | 323 | 413 | 3329 | 508 | 197 | 413 | 478 | 189 | 364 | 367 | 144 | 530 | 3190 | 6519 |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| White            | 308 | 373 | 399 | 148 | 507 | 184 | 532 | 310 | 403 | 3164 | 497 | 173 | 397 | 460 | 169 | 353 | 348 | 130 | 515 | 3042 | 6206 |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Red              | 298 | 367 | 344 | 116 | 491 | 169 | 479 | 270 | 387 | 2921 | 457 | 155 | 372 | 438 | 159 | 312 | 320 | 115 | 463 | 2791 | 5712 |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Par              |  4  |  4  |  4  |  3  |  5  |  3  |  5  |  4  |  4  |  36  |  5  |  3  |  4  |  5  |  3  |  4  |  4  |  3  |  5  |  36  |  72  |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n|                  |     |     |     |     |     |     |     |     |     |      |     |     |     |     |     |     |     |     |     |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Men's Handicap   | 17  |  3  |  1  | 13  |  9  | 15  |  7  | 11  |  5  |      | 16  |  8  |  2  |  4  | 12  | 10  |  6  | 18  | 14  |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Ladies' Handicap | 13  |  7  | 11  | 15  |  1  | 17  |  3  |  9  |  5  |      |  6  | 16  |  8  |  2  | 14  | 12  | 10  | 18  |  4  |      |      |\n|---------------------------------------------------------------------------------------------------------------------------------------------------|\n| Scorer:                                                                | Attest:                                              | Date:             |\n.---------------------------------------------------------------------------------------------------------------------------------------------------."));
    }
};

int main(int argc, const char* argv[]){
    TestRunner::RunAllTests(argc, argv);
}